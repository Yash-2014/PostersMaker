<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AI Festival Poster & Message Maker</title>
<style>
body{font-family:system-ui,Roboto,sans-serif;background:#fff8ec;margin:0;color:#222}
.wrap{max-width:900px;margin:auto;padding:16px}
h1{font-size:20px;margin:0 0 12px;font-weight:600;color:#ff6f00;text-align:center}
.card{background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,0.08);padding:12px;margin-bottom:12px}
label{font-size:13px;color:#555;margin-bottom:4px;display:block}
input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px;box-sizing:border-box}
button.primary{background:#ff6f00;color:#fff;border:0;font-weight:500;cursor:pointer}
.poster-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px;margin-top:8px;max-height:300px;overflow:auto}
.poster-grid img{width:100%;border-radius:8px;object-fit:cover;height:100px;cursor:pointer;border:2px solid transparent}
.poster-grid img.selected{border:2px solid #ff6f00}
canvas{width:100%;border-radius:8px;background:#eee;margin-top:8px}
.actions{display:flex;gap:8px;margin-top:10px}
button.ghost{background:#fff;border:1px solid #ddd}
</style>
</head>
<body>
<div class="wrap">
  <h1>ü™î AI Festival Poster & Message Maker</h1>

  <div class="card">
    <label>Festival / Event</label>
    <select id="occasion">
      <option>Diwali</option>
      <option>Holi</option>
      <option>Independence Day</option>
      <option>Birthday</option>
      <option>Anniversary</option>
      <option>Business Promotion</option>
    </select>

    <div style="height:8px"></div>
    <label>Recipient Name (optional)</label>
    <input id="name" placeholder="e.g. Rahul Sharma">

    <div style="height:8px"></div>
    <label>Tone</label>
    <select id="tone"><option>Friendly</option><option>Formal</option><option>Funny</option></select>

    <div style="height:8px"></div>
    <label>Language</label>
    <select id="lang">
      <option value="both">Both (Hindi + English)</option>
      <option value="hi">Hindi Only</option>
      <option value="en">English Only</option>
    </select>

    <div style="height:8px"></div>
    <div style="display:flex;gap:8px;">
      <button class="primary" id="loadPosters">Load Posters</button>
      <button class="ghost" id="nextPosters">Next Posters</button>
    </div>
  </div>

  <div class="card">
    <label>Posters (Tap to select or upload your own)</label>
    <div class="poster-grid" id="posterGrid"></div>
    <div style="margin-top:6px">
      <input type="file" id="uploadPoster" accept="image/*">
    </div>
  </div>

  <div class="card">
    <label>Generated Message</label>
    <textarea id="message" rows="4"></textarea>
    <button class="primary" id="generateMsg">Generate Message</button>
  </div>

  <div class="card">
    <label>Poster Preview</label>
    <canvas id="canvas" width="720" height="1080"></canvas>
    <div class="actions">
      <button class="primary" id="downloadBtn">Download</button>
      <button class="ghost" id="shareBtn">Share (WhatsApp)</button>
    </div>
  </div>
</div>

<script>
const PIXA_KEY = "52750792-e7733c9281f1e2e96a903f5b5"; 
const occEl=document.getElementById('occasion');
const toneEl=document.getElementById('tone');
const nameEl=document.getElementById('name');
const langEl=document.getElementById('lang');
const msgEl=document.getElementById('message');
const genMsg=document.getElementById('generateMsg');
const posterGrid=document.getElementById('posterGrid');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
let selectedPoster=null;
let currentPage=1;

// Load posters from Pixabay
async function loadPosters(page=1){
  posterGrid.innerHTML="Loading...";
  const query=encodeURIComponent(occEl.value+" festival poster");
  try{
    const res=await fetch(`https://pixabay.com/api/?key=${PIXA_KEY}&q=${query}&image_type=photo&orientation=vertical&per_page=30&page=${page}&safesearch=true`);
    const data=await res.json();
    if(!data.hits || data.hits.length===0) throw new Error("No images");
    posterGrid.innerHTML="";
    data.hits.forEach(img=>{
      const el=document.createElement('img');
      el.src=img.webformatURL;
      el.onclick=()=>{document.querySelectorAll('.poster-grid img').forEach(i=>i.classList.remove('selected'));el.classList.add('selected');selectedPoster=img.largeImageURL;renderPoster(msgEl.value);}
      posterGrid.appendChild(el);
    });
  }catch(e){
    posterGrid.innerHTML="<p style='color:red'>‚ùå Error loading posters</p>";
  }
}
document.getElementById('loadPosters').onclick=()=>{currentPage=1;loadPosters(currentPage);}
document.getElementById('nextPosters').onclick=()=>{currentPage++;loadPosters(currentPage);};

// Gemini message generator via backend proxy
async function generateGeminiMessage(){
  const occ=occEl.value;
  const tone=toneEl.value;
  const lang=langEl.value;
  const nm=nameEl.value || "Friend";

  const prompt=`Write a ${tone.toLowerCase()} ${occ} greeting message for ${nm}.
Language: ${lang==="hi"?"Hindi":lang==="en"?"English":"Both Hindi and English"}.
Make it short (1-2 sentences), festive, warm, and unique each time.`;

  try{
    msgEl.value="‚è≥ Generating message...";
    const res=await fetch("Gemini",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ prompt })
    });
    const data=await res.json();
    const text=data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
    if(text){msgEl.value=text;renderPoster(text);}
    else{msgEl.value="‚ö†Ô∏è Unable to generate message, try again.";}
  }catch(err){
    msgEl.value="‚ùå Error contacting Gemini API.";
  }
}

genMsg.onclick=generateGeminiMessage;

// --- Canvas rendering ---
function renderPoster(text){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!selectedPoster){
    ctx.fillStyle="#fff0cc";ctx.fillRect(0,0,canvas.width,canvas.height);
  }else{
    const img=new Image();img.crossOrigin="anonymous";
    img.onload=()=>{ctx.drawImage(img,0,0,canvas.width,canvas.height);drawText(text);};
    img.src=selectedPoster;
  }drawText(text);
}
function drawText(text){
  ctx.fillStyle="rgba(0,0,0,0.8)";
  ctx.font="bold 26px system-ui";
  const lines=text.split(/\n/);let y=canvas.height-200;
  for(const l of lines){wrapLine(l,y);y+=36;}
}
function wrapLine(text,y){
  const words=text.split(" ");let line="",maxWidth=canvas.width-40,x=20;
  for(let i=0;i<words.length;i++){
    const test=line+words[i]+" ";const m=ctx.measureText(test);
    if(m.width>maxWidth){ctx.fillText(line,x,y);line=words[i]+" ";y+=32;}else{line=test;}
  }ctx.fillText(line,x,y);
}
document.getElementById('uploadPoster').onchange=e=>{
  const file=e.target.files[0];if(!file)return;
  const url=URL.createObjectURL(file);
  selectedPoster=url;
  const img=document.createElement('img');
  img.src=url;img.classList.add('selected');
  posterGrid.prepend(img);
  renderPoster(msgEl.value);
};
document.getElementById('downloadBtn').onclick=()=>{
  canvas.toBlob(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download="poster.png";
    a.click();
  });
};
document.getElementById('shareBtn').onclick=async()=>{
  const blob=await new Promise(r=>canvas.toBlob(r,'image/png'));
  const file=new File([blob],"poster.png",{type:'image/png'});
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    await navigator.share({files:[file],text:msgEl.value});
  }else{
    const txt=encodeURIComponent(msgEl.value);
    window.open("https://wa.me/?text="+txt,"_blank");
  }
};
renderPoster("Select poster and generate message!");
</script>
</body>
</html>
